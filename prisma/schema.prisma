datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  firstName     String?
  lastName          String?
  title             String?
  bio               String?
  skills            String?
  linkedin          String?
  github            String?
  portfolio         String?
  role              String    @default("BENEFICIAIRE")
  resetToken        String?   @unique
  resetTokenExpiry  DateTime?
  // Stripe payment
  hasPaid           Boolean   @default(false)
  stripeCustomerId  String?   @unique
  paidAt            DateTime?
  createdAt         DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]
  assessments   Assessment[]
  cognitiveProfile CognitiveProfile?
  cognitiveInsights CognitiveInsight[]
  cognitiveTestResponses CognitiveTestResponse[]
  cognitiveTestSessions CognitiveTestSession[]
  // Add report relation
  report Report?
  // Certification module
  certificationSessions CertificationSession[]
  certificates          Certificate[]
  // Career project module
  careerProjects        CareerProject[]
  // Accessibility module
  accessibility         Accessibility?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Assessment {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    String      @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations Modules
  lifePath    LifePath?
  experiences Experience[]
  values      UserValue[]
  riasecResult RiasecResult?
  projects    Project[]
}

model LifePath {
  id          String    @id @default(cuid())
  assessmentId String   @unique
  assessment  Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  events      LifeEvent[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model LifeEvent {
  id          String    @id @default(cuid())
  lifePathId  String
  lifePath    LifePath  @relation(fields: [lifePathId], references: [id], onDelete: Cascade)
  year        Int
  title       String
  type        String    // PRO, PERSO, FORMATION
  sentiment   Int       // Echelle 0 à 10 (satisfaction)
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Experience {
  id          String    @id @default(cuid())
  assessmentId String
  assessment  Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  title       String
  company     String
  startDate   DateTime
  endDate     DateTime?
  // Méthode STAR
  situation   String?
  task        String?
  action      String?
  result      String?
  skills      String    // Liste de tags (ex: "Management", "Java")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model UserValue {
  id          String    @id @default(cuid())
  assessmentId String
  assessment  Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  valueName   String
  order       Int       // 1 à 10
  gapScore    Int?      // Satisfaction actuelle (1-5)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model RiasecResult {
  id          String    @id @default(cuid())
  assessmentId String   @unique
  assessment  Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  scoreR      Int
  scoreI      Int
  scoreA      Int
  scoreS      Int
  scoreE      Int
  scoreC      Int
  topCode     String    // Ex: "RIS"
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  certificationSession CertificationSession?
}

model CognitiveProfile {
  id                 String   @id
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  form_score         Int
  color_score        Int
  volume_score       Int
  sound_score        Int
  dominant_cognition String
  profile_code       String
  communication_style String?
  detail_level       String?
  learning_preference String?
  completed_at       DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  certificationSession CertificationSession?
}

model CognitiveInsight {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  insight_type String
  title       String
  description String
  priority    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CognitiveTestResponse {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId    Int
  selectedOption String
  dimension     String
  weight        Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, questionId])
}

model Project {
  id          String    @id @default(cuid())
  assessmentId String
  assessment  Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  title       String
  description String?
  strengths   String? // SWOT
  weaknesses  String?
  opportunities String?
  threats     String?
  actionPlan  ActionStep[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model ActionStep {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  action      String
  deadline    DateTime?
  status      String    @default("TODO") // TODO, DONE
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================
// COGNITIVE ASSESSMENT MODULE (Proprietary)
// ============================================

model CognitiveTestSession {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status      String   @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED
  
  // Test completion flags
  stroopCompleted       Boolean @default(false)
  reactionTimeCompleted Boolean @default(false)
  trailMakingCompleted  Boolean @default(false)
  ranVisualCompleted    Boolean @default(false)
  
  // Raw test data (JSON)
  stroopData       Json?
  reactionTimeData Json?
  trailMakingData  Json?
  ranVisualData    Json?
  
  // Computed signature
  signature   CognitiveSignature?
  
  // Generated report (JSON)
  generatedReport Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
}

model CognitiveSignature {
  id        String   @id @default(cuid())
  sessionId String   @unique
  session   CognitiveTestSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Core cognitive dimensions (normalized 0-100)
  inhibitoryControl   Float
  processingSpeed     Float
  cognitiveFlexibility Float
  accessFluency       Float
  
  // Stability metrics
  reactionVariance    Float
  attentionDrift      Float
  
  // Error profile
  conflictErrors      Float
  sequencingErrors    Float
  
  // Raw metrics for detailed analysis
  rawMetrics          Json
  
  // Textual interpretation
  interpretation      String? @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Report {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Content
  sections       Json // Array of ReportSection for UI
  completeSections Json // CompleteReportSections object

  // Metadata
  generatedAt    DateTime @default(now())
  version        String   @default("2.0")
  tokensCost     Int? // Estimated tokens used
  
  // Regeneration tracking
  generationCount       Int      @default(1)     // Compteur de générations (1ère, 2ème, 3ème...)
  hasExtraGenerationPaid Boolean @default(false) // A payé pour générations supplémentaires (3+)

  updatedAt      DateTime @updatedAt
}

// ============================================
// CERTIFICATION PROFESSIONNELLE MODULE
// ============================================

model CertificationSession {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  
  // Liens modules existants
  riasecResultId  String?  @unique
  riasecResult    RiasecResult? @relation(fields: [riasecResultId], references: [id])
  
  cognitiveProfileId String? @unique
  cognitiveProfile   CognitiveProfile? @relation(fields: [cognitiveProfileId], references: [id])
  
  currentBloc     Int      @default(1)
  answers         Json     @default("{}")
  
  // Scores
  devScore        Int?
  dataScore       Int?
  cyberScore      Int?
  infraScore      Int?
  coherenceScore  Int?
  
  primaryRole     String?
  secondaryRoles  String[] @default([])
  level           String?
  strengths       String[] @default([])
  developmentAreas String[] @default([])
  
  // Relations
  certificate     Certificate?
  
  @@index([userId])
}

model Certificate {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId         String   @unique
  session           CertificationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  issuedAt          DateTime @default(now())
  validUntil        DateTime
  blockchainHash    String   @unique
  blockchainTxHash  String?
  verificationUrl   String
  pdfUrl            String?
  
  jobMatches        JobMatch[]
  
  @@index([userId])
  @@index([blockchainHash])
}

model JobMatch {
  id                String   @id @default(cuid())
  certificateId     String
  certificate       Certificate @relation(fields: [certificateId], references: [id], onDelete: Cascade)
  
  externalJobId     String
  matchScore        Int
  fetchedAt         DateTime @default(now())
  jobData           Json
  
  @@index([certificateId])
  @@unique([certificateId, externalJobId])
}

// ============================================
// CAREER PROJECT MODULE (Universal)
// ============================================

model CareerProject {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Métier cible
  targetRomeCode  String
  targetRomeLabel String
  targetDomain    String
  
  // Motivation et contexte
  motivation      String?  @db.Text
  timeline        String?  // "court_terme" | "moyen_terme" | "long_terme"
  constraints     String?  @db.Text
  
  // Compétences
  currentSkills   String[] @default([])
  requiredSkills  String[] @default([])
  skillsGap       String[] @default([])
  
  // Formations identifiées
  formations      Json?    // Array of formation objects
  
  // Statut
  status          String   @default("DRAFT") // DRAFT, ACTIVE, COMPLETED, ARCHIVED
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([targetRomeCode])
}

// ============================================
// MODULE ACCESSIBILITÉ HANDICAP
// ============================================

model Accessibility {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Déclaration handicap
  hasDisability           Boolean   @default(false)
  disabilityType          String?   // "moteur" | "visuel" | "auditif" | "cognitif" | "psychique" | "multiple" | "invisible"
  
  // Reconnaissance officielle
  hasRQTH                 Boolean   @default(false)  // Reconnaissance Qualité Travailleur Handicapé
  rqthNumber              String?
  rqthExpiryDate          DateTime?
  
  // Besoins d'aménagement
  needsWorkstationAdaptation    Boolean   @default(false)
  needsScheduleFlexibility      Boolean   @default(false)
  needsRemoteWork               Boolean   @default(false)
  needsAccessibleTransport      Boolean   @default(false)
  needsAssistiveTechnology      Boolean   @default(false)
  otherNeeds                    String?   @db.Text
  
  // Compétences compensatoires développées
  compensatorySkills      String[]  @default([])
  
  // Préférences emploi
  preferDisabilityFriendlyCompanies  Boolean   @default(false)
  interestedInAGEFIPHAid             Boolean   @default(false)
  
  // Confidentialité
  shareWithEmployers      Boolean   @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}
