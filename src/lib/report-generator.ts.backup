import { CognitiveSignatureData, RIASECProfile } from "./premium-report-sections";
import {
  generateSignatureCentraleSection,
  generateLectureFonctionnelleSection,
  generateCarteTensionsSection,
  generateZonesVigilanceSection,
  generateProjectionIATransformationSection,
} from "./premium-report-sections";
import * as crypto from 'crypto';
import { generateGeneralReport, type GeneralReportInput } from "./general-report-sections";

/* =======================
   TYPES & INTERFACES
======================= */

/**
 * Interface unifi√©e pour les entr√©es du g√©n√©rateur de rapport
 */
export interface ReportGeneratorInput {
  cognitiveSignature: CognitiveSignatureData;
  riasecProfile?: RIASECProfile;
  userName?: string;
  age?: number;
  occupation?: string;
  experience?: string;
}

/**
 * Interface canonique du rapport complet PERSPECTA (11 sections)
 * PARTIE I - Synth√®se G√©n√©rale (5 sections)
 * PARTIE II - Analyse Cognitive Premium (4 sections)
 * PARTIE III - Transformation (1 section)
 * PARTIE IV - Conclusion (1 section)
 */
export interface CompleteReportSections {
  // PARTIE I - Synth√®se G√©n√©rale
  cadre: string;
  synthese: string;
  croisement_riasec: string;
  scenarios: string;
  environnements_compatibles: string;

  // PARTIE II - Analyse Cognitive Premium
  signature_centrale: string;
  lecture_fonctionnelle: string;
  tensions_cognitives: string;
  zones_vigilance: string;

  // PARTIE III - Transformation
  projection_ia: string;

  // PARTIE IV - Conclusion
  conclusion: string;
}

/**
 * Sections cognitives g√©n√©r√©es de mani√®re d√©terministe
 * (anciennes sections "premium")
 */
interface CognitiveSections {
  signature_centrale: string;
  lecture_fonctionnelle: string;
  tensions_cognitives: string;
  zones_vigilance: string;
  projection_ia: string;
  conclusion: string;
}

/* =======================
   G√âN√âRATION SECTIONS COGNITIVES
======================= */

/**
 * G√©n√®re les 6 sections d'analyse cognitive d√©taill√©e
 * (logique d√©terministe bas√©e sur les scores cognitifs)
 */
function generateCognitiveSections(
  input: ReportGeneratorInput
): CognitiveSections {
  const { cognitiveSignature } = input;

  return {
    signature_centrale: generateSignatureCentraleSection(cognitiveSignature),
    lecture_fonctionnelle: generateLectureFonctionnelleSection(cognitiveSignature),
    tensions_cognitives: generateCarteTensionsSection(cognitiveSignature),
    zones_vigilance: generateZonesVigilanceSection(cognitiveSignature),
    projection_ia: generateProjectionIATransformationSection(cognitiveSignature),
    conclusion: generateConclusionSection(cognitiveSignature),
  };
}

/**
 * G√©n√®re la conclusion strat√©gique du rapport
 */
function generateConclusionSection(sig: CognitiveSignatureData): string {
  const scores = [
    sig.processingSpeed,
    sig.inhibitoryControl,
    sig.cognitiveFlexibility,
    sig.accessFluency
  ].filter(Boolean);

  const scoresText = scores.length > 0 
    ? scores.map(s => `${s}%`).join(', ')
    : 'scores mesur√©s';

  return `Ce rapport d√©crit un fonctionnement cognitif sp√©cifique √† un instant donn√©, bas√© sur des indicateurs comportementaux mesur√©s (${scoresText}).

Il ne constitue ni un diagnostic, ni une pr√©diction, ni une √©valuation normative. Il s'agit d'un outil de compr√©hension destin√© √† √©clairer vos r√©flexions professionnelles dans un contexte de transformation du travail et d'√©volution des environnements cognitifs.

Votre empreinte cognitive n'est pas fig√©e. Elle √©volue avec l'exp√©rience, les contextes et les strat√©gies que vous mobilisez. Ce document propose une photographie actuelle de vos ressources cognitives, qui peut servir de point de d√©part pour une r√©flexion sur votre d√©veloppement professionnel.

Les recommandations formul√©es dans ce rapport visent √† identifier les environnements dans lesquels vos ressources cognitives peuvent s'exprimer de mani√®re optimale, minimisant ainsi les co√ªts d'adaptation et favorisant l'√©panouissement professionnel. Elles ne constituent pas des prescriptions rigides, mais plut√¥t des pistes de r√©flexion √† consid√©rer dans le cadre de votre parcours individuel.`;
}

/* =======================
   ASSEMBLAGE RAPPORT COMPLET
======================= */

/**
 * Fonction principale : g√©n√®re le rapport complet PERSPECTA (11 sections)
 * 
 * Pipeline :
 * 1. G√©n√®re les sections g√©n√©rales via API OpenAI (async)
 * 2. G√©n√®re les sections cognitives (d√©terministe)
 * 3. Assemble les 11 sections dans l'ordre canonique
 * 
 * @param input - Donn√©es cognitives + RIASEC + m√©tadonn√©es utilisateur
 * @returns Promise<CompleteReportSections> - Les 11 sections du rapport
 * @throws Error si g√©n√©ration √©choue ou sections incompl√®tes
 */
export async function assembleCompleteReport(
  input: ReportGeneratorInput
): Promise<CompleteReportSections> {
  console.log("üöÄ D√©marrage g√©n√©ration rapport complet PERSPECTA...");

  // ============================================
  // VALIDATION DES ENTR√âES
  // ============================================
  if (!input.cognitiveSignature) {
    throw new Error("‚ùå cognitiveSignature est requis pour g√©n√©rer le rapport");
  }

  if (!input.riasecProfile) {
    console.warn("‚ö†Ô∏è riasecProfile manquant - utilisation de valeurs par d√©faut");
  }

  // ============================================
  // G√âN√âRATION PARALL√àLE
  // ============================================
  try {
    const [generalSections, cognitiveSections] = await Promise.all([
      generateGeneralReport({
        cognitiveSignature: input.cognitiveSignature,
        riasecProfile: input.riasecProfile || getDefaultRIASECProfile(),
        userName: input.userName,
        age: input.age,
        occupation: input.occupation,
        experience: input.experience,
      }),
      Promise.resolve(generateCognitiveSections(input))
    ]);

    // ============================================
    // ASSEMBLAGE FINAL (11 sections)
    // ============================================
    const completeReport: CompleteReportSections = {
      // PARTIE I - Synth√®se G√©n√©rale (5 sections IA)
      cadre: generalSections.cadre,
      synthese: generalSections.synthese,
      croisement_riasec: generalSections.croisement_riasec,
      scenarios: generalSections.scenarios,
      environnements_compatibles: generalSections.environnements_compatibles,

      // PARTIE II - Analyse Cognitive Premium (4 sections d√©terministes)
      signature_centrale: cognitiveSections.signature_centrale,
      lecture_fonctionnelle: cognitiveSections.lecture_fonctionnelle,
      tensions_cognitives: cognitiveSections.tensions_cognitives,
      zones_vigilance: cognitiveSections.zones_vigilance,

      // PARTIE III - Transformation (1 section d√©terministe)
      projection_ia: cognitiveSections.projection_ia,

      // PARTIE IV - Conclusion (1 section d√©terministe)
      conclusion: cognitiveSections.conclusion,
    };

    // ============================================
    // VALIDATION DES SECTIONS
    // ============================================
    validateReportSections(completeReport);

    console.log("‚úÖ Rapport complet g√©n√©r√© avec succ√®s (11 sections)");
    return completeReport;

  } catch (error) {
    console.error("‚ùå Erreur g√©n√©ration rapport complet:", error);
    throw new Error(
      `√âchec g√©n√©ration rapport PERSPECTA: ${error instanceof Error ? error.message : "erreur inconnue"}`
    );
  }
}

/* =======================
   UTILITAIRES
======================= */

/**
 * Valide que toutes les sections du rapport sont pr√©sentes et non vides
 */
function validateReportSections(report: CompleteReportSections): void {
  const requiredSections: (keyof CompleteReportSections)[] = [
    "cadre",
    "synthese",
    "croisement_riasec",
    "scenarios",
    "environnements_compatibles",
    "signature_centrale",
    "lecture_fonctionnelle",
    "tensions_cognitives",
    "zones_vigilance",
    "projection_ia",
    "conclusion",
  ];

  const missingOrEmpty = requiredSections.filter((key) => {
    const content = report[key];
    return !content || content.trim().length < 50;
  });

  if (missingOrEmpty.length > 0) {
    throw new Error(
      `‚ö†Ô∏è Sections incompl√®tes d√©tect√©es: ${missingOrEmpty.join(", ")}\n` +
      `Le rapport ne peut pas √™tre g√©n√©r√© avec des sections vides.`
    );
  }
}

/**
 * Retourne un profil RIASEC par d√©faut (√©quilibr√©)
 */
function getDefaultRIASECProfile(): RIASECProfile {
  return {
    realistic: 50,
    investigative: 50,
    artistic: 50,
    social: 50,
    enterprising: 50,
    conventional: 50,
  };
}

/**
 * G√©n√®re un hash unique pour le rapport
 */
export function generateReportHash(input: ReportGeneratorInput): string {
  const data = JSON.stringify({
    cognitive: input.cognitiveSignature,
    riasec: input.riasecProfile,
    timestamp: Date.now(),
  });
  
  return crypto
    .createHash('sha256')
    .update(data)
    .digest('hex')
    .slice(0, 16)
    .toUpperCase();
}

/* =======================
   LEGACY - COMPATIBILIT√â
======================= */

/**
 * @deprecated Utiliser assembleCompleteReport() √† la place
 * Conserv√© temporairement pour compatibilit√© descendante
 */
export function generateReportSections(
  input: ReportGeneratorInput
): CognitiveSections {
  console.warn(
    "‚ö†Ô∏è generateReportSections() est d√©pr√©ci√©. " +
    "Utilisez assembleCompleteReport() pour obtenir le rapport complet."
  );
  
  return generateCognitiveSections(input);
}

/**
 * @deprecated Interface legacy - utiliser CompleteReportSections
 */
export interface GeneratedReportSections extends CognitiveSections {
  title: string;
}